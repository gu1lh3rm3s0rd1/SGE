{% extends 'base.html' %}

{% block title %}Cadastrar Entrada - SGE{% endblock %}

{% block content %}
<!-- Campo CSRF para JavaScript -->
{% csrf_token %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-truck text-success"></i>
        Cadastrar Entrada de Estoque
    </h2>
    <a href="{% url 'inflow_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i>
        Voltar
    </a>
</div>

<div class="row">
    <!-- Scanner de Produtos -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-upc-scan me-2"></i>
                    Scanner de Conferência
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label for="scan_input" class="form-label">
                            <i class="bi bi-upc-scan me-2"></i>Escaneie os Produtos
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control form-control-lg" 
                                   id="scan_input" placeholder="Escaneie o código de barras ou digite o código..."
                                   autocomplete="off">
                            <span class="input-group-text">
                                <i class="bi bi-upc-scan text-primary" id="scanner-icon"></i>
                            </span>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            Posicione o cursor no campo e escaneie o código de barras
                        </div>
                        <div id="scan-feedback"></div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="button" class="btn btn-outline-primary" id="clear-scan">
                                <i class="bi bi-arrow-clockwise me-2"></i>Limpar Lista
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lista de produtos escaneados -->
                <div id="scanned-products" class="mt-3">
                    <h6><i class="bi bi-list-check me-2"></i>Produtos Conferidos:</h6>
                    <div id="product-list" class="border rounded p-3 bg-light min-height-100">
                        <p class="text-muted mb-0 text-center">
                            <i class="bi bi-box-seam me-2"></i>
                            Nenhum produto escaneado ainda. Escaneie o primeiro código!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumo e Ações -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Resumo da Entrada
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary mb-0" id="total-items">0</h4>
                        <small class="text-muted">Itens</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success mb-0" id="total-quantity">0</h4>
                        <small class="text-muted">Quantidade</small>
                    </div>
                </div>
                
                <hr>
                
                <div id="quick-stats" class="d-none">
                    <h6>Valor Estimado:</h6>
                    <p class="h5 text-info mb-3">R$ <span id="estimated-value">0,00</span></p>
                </div>
                
                <!-- Seleção de fornecedor -->
                <div class="mb-3">
                    <label for="supplier-select" class="form-label">
                        <i class="fas fa-truck me-2"></i>Fornecedor:
                    </label>
                    <select class="form-select" id="supplier-select">
                        <option value="">Selecionar fornecedor...</option>
                    </select>
                    <div class="form-text">
                        <i class="bi bi-info-circle me-1"></i>
                        Será usado o primeiro fornecedor se não selecionar
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success" id="finalize-entry" disabled>
                        <i class="fas fa-save me-2"></i>
                        Finalizar Entrada
                    </button>
                    <button type="button" class="btn btn-outline-warning" id="export-list">
                        <i class="fas fa-download me-2"></i>
                        Exportar Lista
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Formulário tradicional (backup) -->
<div class="card mt-4">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="fas fa-edit me-2"></i>
            Entrada Manual (Alternativa)
        </h6>
    </div>
    <div class="card-body">
        <form method="post" id="manual-form">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>
                Registrar Entrada Manual
            </button>
        </form>
    </div>
</div>

<!-- Modal para editar quantidade -->
<div class="modal fade" id="quantityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square me-2"></i>
                    Ajustar Quantidade
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Produto:</label>
                    <p id="modal-product-name" class="fw-bold"></p>
                </div>
                <div class="mb-3">
                    <label for="modal-quantity" class="form-label">Quantidade:</label>
                    <input type="number" class="form-control" id="modal-quantity" min="1" value="1">
                </div>
                <div class="mb-3">
                    <label for="modal-notes" class="form-label">Observações:</label>
                    <textarea class="form-control" id="modal-notes" rows="2" placeholder="Observações sobre esta entrada (opcional)"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-quantity">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Reutilizar função de detecção de scanner
function handleBarcodeInput(input, callback) {
    let barcodeBuffer = '';
    let lastInputTime = 0;
    
    input.addEventListener('input', function(e) {
        const currentTime = Date.now();
        const timeDiff = currentTime - lastInputTime;
        
        if (timeDiff < 100 && barcodeBuffer) {
            barcodeBuffer += e.target.value.slice(-1);
        } else {
            barcodeBuffer = e.target.value;
        }
        
        lastInputTime = currentTime;
        
        setTimeout(() => {
            if (barcodeBuffer.length >= 8 && currentTime - lastInputTime >= 150) {
                callback(barcodeBuffer.trim());
                barcodeBuffer = '';
            }
        }, 200);
    });
    
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && barcodeBuffer.length >= 8) {
            e.preventDefault();
            callback(barcodeBuffer.trim());
            barcodeBuffer = '';
        }
    });
}

function showScanNotification(message, type = 'info') {
    const feedbackDiv = document.getElementById('scan-feedback');
    if (!feedbackDiv) return;
    
    feedbackDiv.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show mt-2" role="alert">
            <i class="bi bi-upc-scan me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    setTimeout(() => {
        const alert = feedbackDiv.querySelector('.alert');
        if (alert) alert.remove();
    }, 3000);
}

// Lista de produtos escaneados
let scannedProducts = [];

function searchProductByBarcode(barcode) {
    fetch(`/api/search-product/${barcode}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addProductToList(data.product);
                showScanNotification(
                    `Produto "${data.product.name}" adicionado à lista!`,
                    'success'
                );
                
                // Feedback visual no ícone
                const scannerIcon = document.getElementById('scanner-icon');
                if (scannerIcon) {
                    scannerIcon.className = 'bi bi-check-circle text-success';
                    setTimeout(() => {
                        scannerIcon.className = 'bi bi-upc-scan text-primary';
                    }, 1500);
                }
            } else {
                showScanNotification(
                    `Produto não encontrado: ${barcode}`,
                    'danger'
                );
            }
        })
        .catch(error => {
            console.error('Erro ao buscar produto:', error);
            showScanNotification('Erro ao buscar produto. Tente novamente.', 'danger');
        });
}

function addProductToList(product) {
    // Verificar se produto já está na lista
    const existingIndex = scannedProducts.findIndex(p => p.id === product.id);
    
    if (existingIndex !== -1) {
        // Aumentar quantidade se já existe
        scannedProducts[existingIndex].quantity += 1;
    } else {
        // Adicionar novo produto
        scannedProducts.push({
            ...product,
            quantity: 1,
            notes: ''
        });
    }
    
    updateProductList();
    updateStats();
}

function updateProductList() {
    const productList = document.getElementById('product-list');
    
    if (scannedProducts.length === 0) {
        productList.innerHTML = `
            <p class="text-muted mb-0 text-center">
                <i class="bi bi-box-seam me-2"></i>
                Nenhum produto escaneado ainda. Escaneie o primeiro código!
            </p>
        `;
        return;
    }
    
    const html = scannedProducts.map((product, index) => `
        <div class="row align-items-center border-bottom py-2" data-index="${index}">
            <div class="col-md-6">
                <strong>${product.name}</strong><br>
                <small class="text-muted">
                    ${product.brand} • ${product.size} • ${product.color}<br>
                    Código: ${product.barcode} | Estoque atual: ${product.current_stock}
                </small>
            </div>
            <div class="col-md-3 text-center">
                <span class="badge bg-primary fs-6">Qtd: ${product.quantity}</span>
            </div>
            <div class="col-md-3 text-end">
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary" onclick="editQuantity(${index})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="removeProduct(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    productList.innerHTML = html;
}

function updateStats() {
    const totalItems = scannedProducts.length;
    const totalQuantity = scannedProducts.reduce((sum, p) => sum + p.quantity, 0);
    const estimatedValue = scannedProducts.reduce((sum, p) => sum + (p.cost_price * p.quantity), 0);
    
    document.getElementById('total-items').textContent = totalItems;
    document.getElementById('total-quantity').textContent = totalQuantity;
    document.getElementById('estimated-value').textContent = estimatedValue.toFixed(2).replace('.', ',');
    
    // Habilitar botão de finalizar se há produtos
    const finalizeBtn = document.getElementById('finalize-entry');
    finalizeBtn.disabled = totalItems === 0;
    
    // Mostrar/ocultar stats
    const quickStats = document.getElementById('quick-stats');
    if (totalItems > 0) {
        quickStats.classList.remove('d-none');
    } else {
        quickStats.classList.add('d-none');
    }
}

function editQuantity(index) {
    const product = scannedProducts[index];
    document.getElementById('modal-product-name').textContent = product.name;
    document.getElementById('modal-quantity').value = product.quantity;
    document.getElementById('modal-notes').value = product.notes;
    
    const modal = new bootstrap.Modal(document.getElementById('quantityModal'));
    modal.show();
    
    // Salvar referência do índice
    document.getElementById('save-quantity').dataset.index = index;
}

function removeProduct(index) {
    if (confirm('Remover este produto da lista?')) {
        scannedProducts.splice(index, 1);
        updateProductList();
        updateStats();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Carregar fornecedores
    loadSuppliers();
    
    // Configurar scanner
    const scanInput = document.getElementById('scan_input');
    if (scanInput) {
        handleBarcodeInput(scanInput, function(barcode) {
            searchProductByBarcode(barcode);
            scanInput.value = ''; // Limpar campo após scan
        });
    }
    
    // Botão de limpar lista
    document.getElementById('clear-scan').addEventListener('click', function() {
        if (scannedProducts.length > 0 && confirm('Limpar toda a lista de produtos?')) {
            scannedProducts = [];
            updateProductList();
            updateStats();
        }
    });
    
    // Salvar quantidade no modal
    document.getElementById('save-quantity').addEventListener('click', function() {
        const index = parseInt(this.dataset.index);
        const quantity = parseInt(document.getElementById('modal-quantity').value);
        const notes = document.getElementById('modal-notes').value;
        
        if (quantity > 0) {
            scannedProducts[index].quantity = quantity;
            scannedProducts[index].notes = notes;
            updateProductList();
            updateStats();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('quantityModal'));
            modal.hide();
        }
    });
    
    // Finalizar entrada
    document.getElementById('finalize-entry').addEventListener('click', function() {
        if (scannedProducts.length === 0) return;
        
        const summary = scannedProducts.map(p => 
            `${p.name}: ${p.quantity} unidades`
        ).join('\n');
        
        if (confirm(`Confirmar entrada dos seguintes produtos?\n\n${summary}\n\nEsta ação irá atualizar o estoque dos produtos.`)) {
            // Obter fornecedor selecionado
            const supplierSelect = document.getElementById('supplier-select');
            const supplierId = supplierSelect.value || null;
            
            // Preparar dados para envio
            const requestData = {
                products: scannedProducts.map(p => ({
                    id: p.id,
                    quantity: p.quantity,
                    notes: p.notes || ''
                })),
                supplier_id: supplierId
            };
            
            // Desabilitar botão durante salvamento
            const finalizeBtn = document.getElementById('finalize-entry');
            const originalText = finalizeBtn.innerHTML;
            finalizeBtn.disabled = true;
            finalizeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
            
            // Enviar para API
            fetch('/api/save-bulk-inflows/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Sucesso
                    showScanNotification(
                        `✅ ${data.message} Fornecedor: ${data.supplier}`,
                        'success'
                    );
                    
                    // Limpar lista após sucesso
                    scannedProducts = [];
                    updateProductList();
                    updateStats();
                    
                    // Mostrar resumo detalhado
                    let detailSummary = 'Entradas criadas:\n';
                    data.entries.forEach(entry => {
                        detailSummary += `• ${entry.product_name}: +${entry.quantity} (Estoque atual: ${entry.new_stock})\n`;
                    });
                    alert(detailSummary);
                    
                } else {
                    // Erro
                    showScanNotification(
                        `❌ Erro ao salvar: ${data.error}`,
                        'danger'
                    );
                    alert(`Erro ao salvar entradas:\n${data.error}`);
                }
            })
            .catch(error => {
                console.error('Erro ao salvar entradas:', error);
                showScanNotification(
                    '❌ Erro de comunicação com servidor',
                    'danger'
                );
                alert('Erro de comunicação com o servidor. Tente novamente.');
            })
            .finally(() => {
                // Reabilitar botão
                finalizeBtn.disabled = false;
                finalizeBtn.innerHTML = originalText;
            });
        }
    });
    
    // Exportar lista
    document.getElementById('export-list').addEventListener('click', function() {
        if (scannedProducts.length === 0) {
            alert('Nenhum produto para exportar!');
            return;
        }
        
        // Criar CSV simples
        let csv = 'Produto,Código,Quantidade,Valor Unitário,Total\n';
        scannedProducts.forEach(p => {
            csv += `"${p.name}","${p.barcode}",${p.quantity},${p.cost_price},${(p.cost_price * p.quantity).toFixed(2)}\n`;
        });
        
        // Download do arquivo
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `entrada_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    });
});

function loadSuppliers() {
    // Por simplicidade, vou criar uma lista básica
    // Em um cenário real, faria uma chamada para API de fornecedores
    const supplierSelect = document.getElementById('supplier-select');
    
    // Simular fornecedores disponíveis (você pode buscar via API se necessário)
    const suppliers = [
        { id: 1, name: 'Atacado Fashion' },
        { id: 2, name: 'Confecções de Roupas LTDA' },
        { id: 3, name: 'Distribuidora XYZ' }
    ];
    
    suppliers.forEach(supplier => {
        const option = document.createElement('option');
        option.value = supplier.id;
        option.textContent = supplier.name;
        supplierSelect.appendChild(option);
    });
}
</script>
{% endblock %}
