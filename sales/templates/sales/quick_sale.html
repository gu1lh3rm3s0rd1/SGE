{% extends 'base.html' %}
{% load static %}

{% block title %}Venda R√°pida - SGE{% endblock %}

{% block extra_css %}
<style>
    .calculator-container {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .product-search {
        font-size: 1.2rem;
        padding: 15px;
        border: 3px solid #007bff;
        border-radius: 10px;
    }
    
    .cart-item {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
    }
    
    .cart-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .quantity-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .total-display {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        margin: 20px 0;
    }
    
    .total-amount {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0;
    }
    
    .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
    }
    
    .btn-large {
        padding: 15px;
        font-size: 1.1rem;
        font-weight: bold;
        border-radius: 10px;
    }
    
    .payment-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin: 15px 0;
    }
    
    .payment-btn {
        padding: 10px;
        border: 2px solid #dee2e6;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .payment-btn.active {
        border-color: #007bff;
        background: #e3f2fd;
        color: #007bff;
    }
    
    .recent-sales {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .suggestion-item {
        transition: background-color 0.2s ease;
    }
    
    .suggestion-item:hover {
        background-color: #f8f9fa !important;
    }
    
    #selected-customer {
        min-height: 40px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    @media (max-width: 768px) {
        .action-buttons {
            grid-template-columns: 1fr;
        }
        .payment-options {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Coluna Principal - Interface de Venda -->
        <div class="col-md-8">
            <div class="calculator-container">
                <h2 class="mb-4 text-center" style="color: #212529 !important;">
                    <i class="fas fa-cash-register text-primary"></i>
                    Venda R√°pida
                </h2>
                
                <!-- Busca de Produto -->
                <div class="mb-4">
                    <label class="form-label fw-bold" style="color: #212529 !important;">
                        <i class="fas fa-barcode text-primary"></i>
                        Adicionar Produto
                    </label>
                    <div class="position-relative">
                        <input type="text" 
                               id="product-search" 
                               class="form-control product-search" 
                               placeholder="üîç Digite c√≥digo de barras, SKU ou nome do produto..."
                               autocomplete="off"
                               autofocus>
                        <div class="position-absolute top-50 end-0 translate-middle-y me-3">
                            <i class="fas fa-barcode text-muted" id="barcode-icon"></i>
                        </div>
                        <div id="product-suggestions" class="position-absolute w-100 bg-white border rounded shadow" style="z-index: 1000; display: none;"></div>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Use seu leitor de c√≥digo de barras ou digite manualmente
                    </small>
                </div>
                
                <!-- Carrinho de Compras -->
                <div id="cart-items" class="mb-4">
                    <!-- Itens ser√£o adicionados aqui dinamicamente -->
                </div>
                
                <!-- Total -->
                <div class="total-display">
                    <p class="mb-1">Total da Venda</p>
                    <p class="total-amount" id="total-amount">R$ 0,00</p>
                    <div class="row mt-3">
                        <div class="col-6">
                            <small>Subtotal: <span id="subtotal">R$ 0,00</span></small>
                        </div>
                        <div class="col-6">
                            <small>Desconto: <span id="discount-display">R$ 0,00</span></small>
                        </div>
                    </div>
                </div>
                
                <!-- Desconto -->
                <div class="mb-3">
                    <label class="form-label" style="color: #212529 !important;">Desconto (R$)</label>
                    <input type="number" id="discount-input" class="form-control" 
                           min="0" step="0.01" value="0" 
                           placeholder="0,00">
                </div>
                
                <!-- Forma de Pagamento -->
                <div class="mb-4">
                    <label class="form-label fw-bold" style="color: #212529 !important;">Forma de Pagamento</label>
                    <div class="payment-options">
                        <button type="button" class="payment-btn active" style="color: #212529 !important;" data-payment="dinheiro">
                            <i class="fas fa-money-bill-wave"></i><br>Dinheiro
                        </button>
                        <button type="button" class="payment-btn" style="color: #212529 !important;" data-payment="cartao_debito">
                            <i class="fas fa-credit-card"></i><br>D√©bito
                        </button>
                        <button type="button" class="payment-btn" style="color: #212529 !important;" data-payment="cartao_credito">
                            <i class="fas fa-credit-card"></i><br>Cr√©dito
                        </button>
                        <button type="button" class="payment-btn" style="color: #212529 !important;" data-payment="pix">
                            <i class="fas fa-qrcode"></i><br>PIX
                        </button>
                    </div>
                </div>
                
                <!-- Bot√µes de A√ß√£o -->
                <div class="action-buttons">
                    <button type="button" id="clear-cart" class="btn btn-outline-secondary btn-large">
                        <i class="fas fa-trash"></i> Limpar
                    </button>
                    <button type="button" id="finalize-sale" class="btn btn-success btn-large">
                        <i class="fas fa-check"></i> Finalizar Venda
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Coluna Lateral - Informa√ß√µes -->
        <div class="col-md-4">
            <!-- Cliente -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-user"></i> Cliente
                    </h6>
                </div>
                <div class="card-body">
                    <div class="position-relative">
                        <input type="text" id="customer-search" class="form-control mb-2" 
                               placeholder="Buscar cliente por nome, email ou telefone..."
                               autocomplete="off">
                        <div id="customer-suggestions" class="position-absolute w-100 bg-white border rounded shadow" style="z-index: 1000; display: none;"></div>
                    </div>
                    <div id="selected-customer" class="text-muted">
                        <small style="color: #212529 !important;"><i class="fas fa-user-slash"></i> Cliente avulso</small>
                    </div>
                    <div class="mt-2">
                        <button type="button" id="add-new-customer" class="btn btn-outline-primary btn-sm w-100">
                            <i class="fas fa-user-plus"></i> Novo Cliente
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Atalhos -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-keyboard"></i> Atalhos
                    </h6>
                </div>
                <div class="card-body">
                    <small class="d-block"><kbd>F1</kbd> Buscar produto</small>
                    <small class="d-block"><kbd>F2</kbd> Novo cliente</small>
                    <small class="d-block"><kbd>F3</kbd> Buscar cliente</small>
                    <small class="d-block"><kbd>F9</kbd> Finalizar venda</small>
                    <small class="d-block"><kbd>Esc</kbd> Limpar carrinho</small>
                </div>
            </div>
            
            <!-- Vendas Recentes -->
            {% if recent_sales %}
            <div class="recent-sales">
                <h6 class="mb-3" style="color: #212529 !important;">
                    <i class="fas fa-history" style="color: #212529 !important;"></i> Vendas Recentes
                </h6>
                {% for sale in recent_sales %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <small class="card-text" style="color: #212529 !important;">#{{ sale.id }}</small>
                        <br>
                        <small style="color: #212529 !important;">{{ sale.created_at|date:"d/m H:i" }}</small>
                    </div>
                    <div class="text-end" style="color: #212529 !important;">
                        <strong>R$ {{ sale.final_amount|floatformat:2 }}</strong>
                        <br>
                        <small class="card-text" style="color: #212529 !important;">{{ sale.get_payment_method_display }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Novo Cliente -->
<div class="modal fade" id="newCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus"></i> Novo Cliente
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="new-customer-form">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nome *</label>
                        <input type="text" id="customer-name" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Telefone</label>
                                <input type="tel" id="customer-phone" class="form-control" 
                                       placeholder="(11) 99999-9999">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" id="customer-email" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">CPF</label>
                        <input type="text" id="customer-cpf" class="form-control" 
                               placeholder="000.000.000-00">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="save-customer" class="btn btn-primary">
                    <i class="fas fa-save"></i> Salvar Cliente
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o -->
<div class="modal fade" id="confirmSaleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle"></i> Confirmar Venda
                </h5>
            </div>
            <div class="modal-body">
                <div id="sale-summary">
                    <!-- Resumo da venda ser√° preenchido aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="confirm-sale" class="btn btn-success">Confirmar Venda</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Vari√°veis globais
let cart = [];
let selectedCustomer = null;
let selectedPayment = 'dinheiro';

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    initializeKeyboardShortcuts();
    updateCartDisplay();
});

// Event listeners
function initializeEventListeners() {
    // Busca de produto com suporte a leitor de c√≥digo de barras
    const productSearch = document.getElementById('product-search');
    productSearch.addEventListener('input', debounce(searchProducts, 300));
    productSearch.addEventListener('keydown', handleProductSearchKeydown);
    
    // Detectar entrada de c√≥digo de barras (leitores USB)
    productSearch.addEventListener('input', handleBarcodeInput);
    
    // Busca de cliente
    const customerSearch = document.getElementById('customer-search');
    customerSearch.addEventListener('input', debounce(searchCustomers, 300));
    customerSearch.addEventListener('keydown', handleCustomerSearchKeydown);
    
    // Desconto
    document.getElementById('discount-input').addEventListener('input', updateCartDisplay);
    
    // Pagamento
    document.querySelectorAll('.payment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            selectPaymentMethod(this.dataset.payment);
        });
    });
    
    // Bot√µes de a√ß√£o
    document.getElementById('clear-cart').addEventListener('click', clearCart);
    document.getElementById('finalize-sale').addEventListener('click', showSaleConfirmation);
    document.getElementById('confirm-sale').addEventListener('click', processSale);
    
    // Cliente
    document.getElementById('add-new-customer').addEventListener('click', showNewCustomerModal);
    document.getElementById('save-customer').addEventListener('click', saveNewCustomer);
}

// Atalhos de teclado
function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F1') {
            e.preventDefault();
            document.getElementById('product-search').focus();
        } else if (e.key === 'F2') {
            e.preventDefault();
            showNewCustomerModal();
        } else if (e.key === 'F3') {
            e.preventDefault();
            document.getElementById('customer-search').focus();
        } else if (e.key === 'F9') {
            e.preventDefault();
            showSaleConfirmation();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            clearCart();
        }
    });
}

// Busca de produtos
function searchProducts() {
    const query = document.getElementById('product-search').value.trim();
    if (query.length < 2) {
        hideProductSuggestions();
        return;
    }
    
    fetch(`/sales/api/products/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            showProductSuggestions(data.products);
        })
        .catch(error => {
            console.error('Erro na busca:', error);
        });
}

// Exibir sugest√µes de produtos
function showProductSuggestions(products) {
    const container = document.getElementById('product-suggestions');
    
    if (products.length === 0) {
        hideProductSuggestions();
        return;
    }
    
    let html = '';
    products.forEach(product => {
        html += `
            <div class="suggestion-item p-2 border-bottom" 
                 style="cursor: pointer;"
                 onclick="addProductToCart(${product.id}, '${product.display_name}', ${product.selling_price})">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong style="color: #212529 !important;">${product.title}</strong>
                        <br>
                        <small class="card-text" style="color: #212529 !important;">${product.size} - ${product.color}</small>
                        <br>
                        <small class="text-success">${product.stock_info}</small>
                    </div>
                    <div class="text-end">
                        <strong class="text-success">R$ ${product.selling_price.toFixed(2)}</strong>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    container.style.display = 'block';
}

// Esconder sugest√µes
function hideProductSuggestions() {
    document.getElementById('product-suggestions').style.display = 'none';
}

// Tratar teclas na busca de produto
function handleProductSearchKeydown(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const suggestions = document.querySelectorAll('.suggestion-item');
        if (suggestions.length > 0) {
            suggestions[0].click();
        }
    }
}

// Detectar e processar entrada de c√≥digo de barras
let barcodeTimeout;
let barcodeBuffer = '';

function handleBarcodeInput(e) {
    const input = e.target.value;
    
    // Detectar se √© entrada r√°pida de c√≥digo de barras (geralmente > 8 caracteres digitados rapidamente)
    if (input.length >= 8 && isNumeric(input)) {
        // Mostrar indicador visual
        showBarcodeDetected();
        
        // Buscar produto automaticamente ap√≥s pequeno delay
        clearTimeout(barcodeTimeout);
        barcodeTimeout = setTimeout(() => {
            searchProductByBarcode(input);
        }, 100);
    }
}

// Verificar se string √© num√©rica (c√≥digos de barras s√£o geralmente num√©ricos)
function isNumeric(str) {
    return /^\d+$/.test(str);
}

// Mostrar indicador de c√≥digo de barras detectado
function showBarcodeDetected() {
    const icon = document.getElementById('barcode-icon');
    const input = document.getElementById('product-search');
    
    // Anima√ß√£o visual
    icon.classList.remove('fa-barcode');
    icon.classList.add('fa-check-circle', 'text-success');
    input.style.borderColor = '#28a745';
    
    // Resetar ap√≥s 2 segundos
    setTimeout(() => {
        icon.classList.remove('fa-check-circle', 'text-success');
        icon.classList.add('fa-barcode');
        icon.classList.add('text-muted');
        input.style.borderColor = '';
    }, 2000);
}

// Buscar produto especificamente por c√≥digo de barras
function searchProductByBarcode(barcode) {
    fetch(`/sales/api/products/?q=${encodeURIComponent(barcode)}`)
        .then(response => response.json())
        .then(data => {
            if (data.products && data.products.length > 0) {
                // Se encontrou exatamente um produto, adicionar automaticamente
                if (data.products.length === 1) {
                    const product = data.products[0];
                    addProductToCart(product.id, product.display_name, product.selling_price);
                    
                    // Feedback sonoro/visual
                    showSuccessNotification(`Produto adicionado: ${product.title}`);
                } else {
                    // Se encontrou v√°rios, mostrar sugest√µes
                    showProductSuggestions(data.products);
                }
            } else {
                // C√≥digo n√£o encontrado
                showErrorNotification(`C√≥digo de barras n√£o encontrado: ${barcode}`);
            }
        })
        .catch(error => {
            console.error('Erro na busca por c√≥digo de barras:', error);
            showErrorNotification('Erro ao buscar produto');
        });
}

// Notifica√ß√µes visuais
function showSuccessNotification(message) {
    const notification = createNotification(message, 'success');
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function showErrorNotification(message) {
    const notification = createNotification(message, 'danger');
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function createNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    return notification;
}

// Adicionar produto ao carrinho
function addProductToCart(productId, productName, price) {
    const existingItem = cart.find(item => item.productId === productId);
    
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({
            productId: productId,
            productName: productName,
            price: price,
            quantity: 1
        });
    }
    
    updateCartDisplay();
    hideProductSuggestions();
    document.getElementById('product-search').value = '';
    document.getElementById('product-search').focus();
}

// Atualizar exibi√ß√£o do carrinho
function updateCartDisplay() {
    const cartContainer = document.getElementById('cart-items');
    
    if (cart.length === 0) {
        cartContainer.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-shopping-cart fa-3x mb-3" style="color: #212529 !important;"></i>
                <p style="color: #212529 !important;">Carrinho vazio</p>
                <small style="color: #212529 !important;">Use o leitor de c√≥digo de barras ou busque produtos pelo nome</small>
            </div>
        `;
    } else {
        let html = '';
        cart.forEach((item, index) => {
            const total = item.price * item.quantity;
            html += `
                <div class="cart-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <strong style="color: #212529 !important;">${item.productName}</strong>
                            <br>
                            <small class="card-text" style="color: #212529 !important;">R$ ${item.price.toFixed(2)} cada</small>
                        </div>
                        <div class="quantity-controls">
                            <button class="btn btn-outline-primary quantity-btn" 
                                    onclick="changeQuantity(${index}, -1)">-</button>
                            <span class="mx-2 fw-bold" style="color: #212529 !important;">${item.quantity}</span>
                            <button class="btn btn-outline-primary quantity-btn" 
                                    onclick="changeQuantity(${index}, 1)">+</button>
                        </div>
                        <div class="text-end ms-3">
                            <strong class="text-success">R$ ${total.toFixed(2)}</strong>
                            <br>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="removeFromCart(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        cartContainer.innerHTML = html;
    }
    
    updateTotals();
}

// Alterar quantidade
function changeQuantity(index, change) {
    cart[index].quantity += change;
    if (cart[index].quantity <= 0) {
        cart.splice(index, 1);
    }
    updateCartDisplay();
}

// Remover do carrinho
function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartDisplay();
}

// Busca de clientes
function searchCustomers() {
    const query = document.getElementById('customer-search').value.trim();
    if (query.length < 2) {
        hideCustomerSuggestions();
        return;
    }
    
    fetch(`/sales/api/customers/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            showCustomerSuggestions(data.customers);
        })
        .catch(error => {
            console.error('Erro na busca de clientes:', error);
        });
}

// Exibir sugest√µes de clientes
function showCustomerSuggestions(customers) {
    const container = document.getElementById('customer-suggestions');
    
    if (customers.length === 0) {
        hideCustomerSuggestions();
        return;
    }
    
    let html = '';
    customers.forEach(customer => {
        html += `
            <div class="suggestion-item p-2 border-bottom" 
                 style="cursor: pointer;"
                 onclick="selectCustomer(${customer.id}, '${customer.name}', '${customer.phone}', '${customer.email}')">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong style="color: #212529 !important;">${customer.name}</strong>
                        ${customer.phone ? `<br><small class="text-muted" style="color: #212529 !important;"><i class="fas fa-phone"></i> ${customer.phone}</small>` : ''}
                        ${customer.email ? `<br><small class="text-muted" style="color: #212529 !important;"><i class="fas fa-envelope"></i> ${customer.email}</small>` : ''}
                    </div>
                    <div>
                        <i class="fas fa-user-check text-success"></i>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    container.style.display = 'block';
}

// Esconder sugest√µes de clientes
function hideCustomerSuggestions() {
    document.getElementById('customer-suggestions').style.display = 'none';
}

// Tratar teclas na busca de cliente
function handleCustomerSearchKeydown(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const suggestions = document.querySelectorAll('#customer-suggestions .suggestion-item');
        if (suggestions.length > 0) {
            suggestions[0].click();
        }
    } else if (e.key === 'Escape') {
        hideCustomerSuggestions();
        clearSelectedCustomer();
    }
}

// Selecionar cliente
function selectCustomer(id, name, phone, email) {
    selectedCustomer = { id, name, phone, email };
    
    document.getElementById('selected-customer').innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-user text-success"></i>
                <strong style="color: #212529 !important;">${name}</strong>
                ${phone ? `<br><small class="text-muted"><i class="fas fa-phone"></i> ${phone}</small>` : ''}
                ${email ? `<br><small class="text-muted"><i class="fas fa-envelope"></i> ${email}</small>` : ''}
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearSelectedCustomer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    hideCustomerSuggestions();
    document.getElementById('customer-search').value = '';
}

// Limpar cliente selecionado
function clearSelectedCustomer() {
    selectedCustomer = null;
    document.getElementById('selected-customer').innerHTML = `
        <small><i class="fas fa-user-slash"></i> Cliente avulso</small>
    `;
    document.getElementById('customer-search').value = '';
    hideCustomerSuggestions();
}

// Mostrar modal de novo cliente
function showNewCustomerModal() {
    const modal = new bootstrap.Modal(document.getElementById('newCustomerModal'));
    modal.show();
    
    // Limpar formul√°rio
    document.getElementById('new-customer-form').reset();
    
    // Aplicar m√°scaras
    applyInputMasks();
    
    // Focar no campo nome
    setTimeout(() => {
        document.getElementById('customer-name').focus();
    }, 500);
}

// Aplicar m√°scaras de entrada
function applyInputMasks() {
    const phoneInput = document.getElementById('customer-phone');
    const cpfInput = document.getElementById('customer-cpf');
    
    // M√°scara de telefone
    phoneInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
        value = value.replace(/(\d)(\d{4})$/, '$1-$2');
        this.value = value;
    });
    
    // M√°scara de CPF
    cpfInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        this.value = value;
    });
}

// Salvar novo cliente
function saveNewCustomer() {
    const name = document.getElementById('customer-name').value.trim();
    if (!name) {
        alert('Nome √© obrigat√≥rio');
        document.getElementById('customer-name').focus();
        return;
    }
    
    const customerData = {
        name: name,
        phone: document.getElementById('customer-phone').value.trim(),
        email: document.getElementById('customer-email').value.trim(),
        cpf: document.getElementById('customer-cpf').value.trim()
    };
    
    fetch('/sales/api/customer/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(customerData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Selecionar o novo cliente
            selectCustomer(
                data.customer.id,
                data.customer.name,
                customerData.phone,
                customerData.email
            );
            
            // Fechar modal
            bootstrap.Modal.getInstance(document.getElementById('newCustomerModal')).hide();
            
            alert('Cliente cadastrado com sucesso!');
        } else {
            alert('Erro ao cadastrar cliente: ' + JSON.stringify(data.errors || data.error));
        }
    })
    .catch(error => {
        console.error('Erro ao salvar cliente:', error);
        alert('Erro ao cadastrar cliente. Tente novamente.');
    });
}

// Atualizar totais
function updateTotals() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const discount = parseFloat(document.getElementById('discount-input').value) || 0;
    const total = Math.max(0, subtotal - discount);
    
    document.getElementById('subtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
    document.getElementById('discount-display').textContent = `R$ ${discount.toFixed(2)}`;
    document.getElementById('total-amount').textContent = `R$ ${total.toFixed(2)}`;
}

// Selecionar forma de pagamento
function selectPaymentMethod(method) {
    selectedPayment = method;
    document.querySelectorAll('.payment-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-payment="${method}"]`).classList.add('active');
}

// Limpar carrinho
function clearCart() {
    if (cart.length > 0 && confirm('Deseja realmente limpar o carrinho?')) {
        cart = [];
        updateCartDisplay();
        document.getElementById('discount-input').value = '0';
        document.getElementById('product-search').focus();
    }
}

// Mostrar confirma√ß√£o de venda
function showSaleConfirmation() {
    if (cart.length === 0) {
        alert('Adicione produtos ao carrinho antes de finalizar a venda.');
        return;
    }
    
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const discount = parseFloat(document.getElementById('discount-input').value) || 0;
    const total = Math.max(0, subtotal - discount);
    
    let summaryHtml = `
        <div class="mb-3">
            <h6>Itens da Venda:</h6>
            <ul class="list-unstyled">
    `;
    
    cart.forEach(item => {
        summaryHtml += `
            <li class="d-flex justify-content-between">
                <span>${item.quantity}x ${item.productName}</span>
                <span>R$ ${(item.price * item.quantity).toFixed(2)}</span>
            </li>
        `;
    });
    
    summaryHtml += `
            </ul>
        </div>
        <div class="border-top pt-3">
            <div class="d-flex justify-content-between">
                <span>Subtotal:</span>
                <span>R$ ${subtotal.toFixed(2)}</span>
            </div>
            <div class="d-flex justify-content-between">
                <span>Desconto:</span>
                <span>R$ ${discount.toFixed(2)}</span>
            </div>
            <div class="d-flex justify-content-between fw-bold">
                <span>Total:</span>
                <span class="text-success">R$ ${total.toFixed(2)}</span>
            </div>
            <div class="mt-2">
                <small class="text-muted">Pagamento: ${getPaymentMethodName(selectedPayment)}</small>
            </div>
        </div>
    `;
    
    document.getElementById('sale-summary').innerHTML = summaryHtml;
    new bootstrap.Modal(document.getElementById('confirmSaleModal')).show();
}

// Processar venda
function processSale() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const discount = parseFloat(document.getElementById('discount-input').value) || 0;
    
    const saleData = {
        items: cart.map(item => ({
            product_id: item.productId,
            quantity: item.quantity,
            unit_price: item.price
        })),
        customer_id: selectedCustomer ? selectedCustomer.id : null,
        discount: discount,
        payment_method: selectedPayment,
        notes: ''
    };
    
    fetch('/sales/quick/process/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(saleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.message}\nTotal: R$ ${data.total.toFixed(2)}`);
            
            // Limpar carrinho e fechar modal
            cart = [];
            document.getElementById('discount-input').value = '0';
            updateCartDisplay();
            bootstrap.Modal.getInstance(document.getElementById('confirmSaleModal')).hide();
            
            // Perguntar se quer imprimir recibo
            if (confirm('Deseja visualizar o recibo da venda?')) {
                window.open(`/sales/${data.sale_id}/receipt/`, '_blank');
            }
            
            document.getElementById('product-search').focus();
        } else {
            alert(`Erro: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Erro ao processar venda:', error);
        alert('Erro ao processar venda. Tente novamente.');
    });
}

// Fun√ß√µes auxiliares
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function getPaymentMethodName(method) {
    const methods = {
        'dinheiro': 'Dinheiro',
        'cartao_debito': 'Cart√£o de D√©bito',
        'cartao_credito': 'Cart√£o de Cr√©dito',
        'pix': 'PIX'
    };
    return methods[method] || method;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Fechar sugest√µes ao clicar fora
document.addEventListener('click', function(e) {
    if (!e.target.closest('#product-search') && !e.target.closest('#product-suggestions')) {
        hideProductSuggestions();
    }
    if (!e.target.closest('#customer-search') && !e.target.closest('#customer-suggestions')) {
        hideCustomerSuggestions();
    }
});
</script>
{% endblock %}
